{% extends 'base.html' %}
{% load report_extras %}
{% block nav_title %} 模型訓練任務 {% endblock %}
{% block page_title %}
    模型訓練任務列表
{% endblock %}
{% block page_functions %}
    {% if user.is_staff %}
        <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <a class="ml-auto" href="{% url 'modeling_jobs:job-create' %}">建立新任務</a>
        </div>
    {% endif %}
{% endblock %}
{% block content %}

    <!--test model CSV Modal-->
    {% for job in modeling_jobs %}
        <div class="modal fade" id="test-ext-data-{{ job.id }}" tabindex="-1" role="dialog"
             aria-labelledby="exampleModalLabel"
             aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">使用額外測試集</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form action="{% url 'modeling_jobs:api-ext-testing-model' job.id %}" method="post"
                              enctype="multipart/form-data">
                            <div class="form-group">
                                <label class="col-form-label" for="test_csv_file">輸入檔案(.csv) : </label>
                                <input type="file" id="test_csv_file" name="ext_test_file" accept=".csv"
                                       class="csv_file" required>
                            </div>
                            <label hidden>
                                <input type="text" hidden name="job_id" value="{{ job.id }}">
                            </label>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-primary">
                                    上傳
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}



    <!--main-->
    <div class="row">
        <div class="col-12">
            <table class="table table-striped">
                <thead>
                <tr>
                    <th>id</th>
                    <th scope="col">模型名稱</th>
                    <th scope="col">模型類型</th>
                    <th scope="col">模型敘述</th>
                    <th scope="col">是否為多標籤</th>
                    <th scope="col">使用資料</th>
                    <th scope="col">建立時間</th>
                    <th scope="col">訓練模型</th>
                    <th scope="col">測試模型</th>
                    <th>訓練狀態</th>
                    <th scope="col">編輯</th>
                </tr>
                </thead>
                <tbody>
                {% for job in modeling_jobs %}
                    <tr>
                        <td>{{ job.id }}</td>
                        <td><a href="{% url 'modeling_jobs:job-detail' job.id %}">{{ job.name }}</a></td>
                        <td>{{ job.get_model_type_display }}</td>
                        <td>{{ job.description }}</td>
                        <td>{{ job.is_multi_label }}</td>
                        <td><a href="{% url 'labeling_jobs:job-detail' job.jobRef.id %}">{{ job.jobRef.name }}</a></td>
                        <td>{{ job.created_at|date:"SHORT_DATE_FORMAT" }}</td>
                        <td>
                            <button id="train-btn-{{ job.id }}" class="btn btn-info btn-sm"
                                    onclick="train_model({{ job.id }},'{% url 'modeling_jobs:training-model' job.id %}')">
                                開始訓練
                            </button>
                        </td>
                        <td>
                            <button id="test-btn-{{ job.id }}" class="btn btn-primary btn-sm" hidden
                                    data-toggle="modal" data-target="#test-ext-data-{{ job.id }}">
                                測試
                            </button>
                        </td>
                        <td>
                            <span id="state-{{ job.id }}"></span>
                        </td>


                        <td>
                            <button id="btnGroupDrop1" type="button" class="btn btn-success dropdown-toggle btn-sm"
                                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                動作
                            </button>
                            <div class="dropdown-menu" aria-labelledby="btnGroupDrop1">
                                <a class="dropdown-item modify_btn"
                                   href="{% url 'modeling_jobs:job-update' job.id %}">
                                    修改模型
                                </a>
                                <a class="dropdown-item delete_btn"
                                   href="{% url 'modeling_jobs:job-delete' job.id %}">刪除</a>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>


    </script>
{% endblock %}

{% block custom_script %}
    <script>

        function train_model(job_id, train_url) {
            set_row_processing_display(job_id)
            $.post(train_url)
        }


        {#function test_model(job_id) {#}
        {#    let form = $('#test-ext-data-' +job_id).find('form')#}
        {#    console.log(form)#}
        {#    var aj = $.ajax({#}
        {#        url: '{% url "modeling_jobs:api-doc-testing-model" %}',#}
        {#        processData: false,#}
        {#        contentType: false,#}
        {#        catch: false,#}
        {#        data: form.serialize(),#}
        {#        type: 'post',#}
        {#        success: function (result) {#}
        {#            if (result == '欄位不符合') {#}
        {#                Swal.fire("Error", '欄位不符合', "error");#}
        {#            } else if (result == '請先訓練模型') {#}
        {#                Swal.fire("Error", '請先訓練模型', "error");#}
        {#            } else {#}
        {#                Swal.fire("訓練中.....", 'success', "success").then(() => {#}
        {#                    location.reload()#}
        {#                })#}
        {#            }#}
        {#        }#}
        {#    })#}
        {#}#}

            function showResult(modeling_job_id) {
                var aj = $.ajax({
                    url: 'show_result',
                    data: {
                        modeling_job_id: modeling_job_id,
                    },
                    type: 'post',
                    success: function (result) {
                        console.log("Done")
                    }
                })
            }

            function set_row_done_display(job_id) {
                $('#state-' + job_id).text("完成")
                $('#train-btn-' + job_id)
                    .text("重新訓練")
                    .removeClass("disabled")
                $('#test-btn-' + job_id).attr("hidden", false)
            }

            function set_row_processing_display(job_id) {
                $('#state-' + job_id).text("處理中")
                $('#train-btn-' + job_id)
                    .text("訓練中")
                    .addClass("disabled")
                $('#test-btn-' + job_id).attr("hidden", true)
            }

            function set_row_wait_display(job_id) {
                $('#state-' + job_id).text("等待中")
                $('#train-btn-' + job_id)
                    .text("開始訓練")
                    .removeClass("disabled")
                $('#test-btn-' + job_id).attr("hidden", true)
            }

            function set_row_error_display(job_id) {
                $('#state-' + job_id).text("錯誤")
                $('#train-btn-' + job_id).text("重試")
                    .removeClass("disabled")
                $('#test-btn-' + job_id).attr("hidden", true)
            }

            function get_progress(url) {
                return $.get({
                    url: url
                })
            }

            function update_progress(job_id, url) {
                {#var state = "wait"#}
                get_progress(url).done(function (result) {
                    let timeout = 10000
                    console.log(result)
                    let state = result.state
                    let elem_id = '#state-' + job_id
                    console.log(elem_id)
                    $(elem_id).text(state)
                    switch (state) {
                        case 'done':
                            set_row_done_display(job_id)
                            break
                        case 'wait':
                            set_row_wait_display(job_id)
                            break
                        case 'processing':
                            timeout = 1000
                            set_row_processing_display(job_id)
                            break
                        default:
                            console.log(state)
                            set_row_error_display(job_id)
                    }
                    setTimeout(function () {
                        {#console.log(url)#}
                        update_progress(job_id, url)
                    }, timeout);
                });
            }
            {% for job in modeling_jobs %}
                update_progress({{ job.id }}, "{% url 'modeling_jobs:api-job-progress' job.id %}")
            {% endfor %}
    </script>
{% endblock %}